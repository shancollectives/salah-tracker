<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Salah Tracker</title>

    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#059669">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://i.ibb.co/ZRjmkWdj/Cream-Orange-Elegant-Mosque-Islamic-Center-Logo.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; -webkit-tap-highlight-color: transparent; transition: background-color 0.3s ease; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .animate-slide-up { animation: slideUp 0.3s ease-out forwards; }
        @keyframes pop { 0% { transform: scale(1); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }
        .animate-pop { animation: pop 0.3s ease-out; }
    </style>
</head>
<body class="bg-slate-50 dark:bg-black text-slate-900 dark:text-slate-100">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        const Icon = ({ name, size = 20, className = "" }) => {
            useEffect(() => { if (window.lucide) window.lucide.createIcons(); }, [name]);
            return <i data-lucide={name} style={{ width: size, height: size }} className={className}></i>;
        };

        const App = () => {
            const [records, setRecords] = useState(() => JSON.parse(localStorage.getItem('salah_records') || '{}'));
            const [currentDate, setCurrentDate] = useState(new Date());
            const [view, setView] = useState('daily');
            const [darkMode, setDarkMode] = useState(() => {
                const saved = localStorage.getItem('theme');
                return saved ? saved === 'dark' : window.matchMedia('(prefers-color-scheme: dark)').matches;
            });
            const [isCalendarOpen, setIsCalendarOpen] = useState(false);
            const [reflection, setReflection] = useState(null);
            const [loadingRef, setLoadingRef] = useState(false);

            const prayers = [
                { id: 'fajr', name: 'Fajr', icon: 'sunrise' },
                { id: 'dhuhr', name: 'Dhuhr', icon: 'sun' },
                { id: 'asr', name: 'Asr', icon: 'cloud-sun' },
                { id: 'maghrib', name: 'Maghrib', icon: 'sunset' },
                { id: 'isha', name: 'Isha', icon: 'moon-star' }
            ];

            const dateKey = currentDate.toLocaleDateString('en-CA');

            // Corrected Dark Mode Logic
            useEffect(() => {
                const root = window.document.documentElement;
                if (darkMode) {
                    root.classList.add('dark');
                    localStorage.setItem('theme', 'dark');
                } else {
                    root.classList.remove('dark');
                    localStorage.setItem('theme', 'light');
                }
            }, [darkMode]);

            useEffect(() => { localStorage.setItem('salah_records', JSON.stringify(records)); }, [records]);

            const handleUpdate = (id, status) => {
                setRecords(prev => ({
                    ...prev,
                    [dateKey]: { ...prev[dateKey], [id]: prev[dateKey]?.[id] === status ? null : status }
                }));
            };

            const streak = useMemo(() => {
                let count = 0; let d = new Date();
                const check = (date) => {
                    const k = date.toLocaleDateString('en-CA');
                    return records[k] && Object.values(records[k]).some(v => v === 'on_time' || v === 'late');
                };
                if (!check(d)) d.setDate(d.getDate() - 1);
                while (check(d)) { count++; d.setDate(d.getDate() - 1); if (count > 999) break; }
                return count;
            }, [records]);

            const lifetimeStats = useMemo(() => {
                const s = { on_time: 0, late: 0, missed: 0 };
                Object.values(records).forEach(day => {
                    Object.values(day).forEach(v => { if (s[v] !== undefined) s[v]++; });
                });
                return s;
            }, [records]);

            const fetchReflection = async () => {
                setLoadingRef(true);
                try {
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: "One short encouraging Islamic reflection on prayer consistency (1 sentence)." }] }]
                        })
                    });
                    const data = await res.json();
                    setReflection(data.candidates?.[0]?.content?.parts?.[0]?.text || "Prayer is the connection between the slave and the Creator. ✨");
                } catch (e) {
                    setReflection("Consistency is the path to peace. ✨");
                } finally {
                    setLoadingRef(false);
                }
            };

            const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const firstDay = new Date(year, month, 1).getDay();
            const calendarDays = [];
            for (let i = 0; i < firstDay; i++) calendarDays.push(null);
            for (let i = 1; i <= daysInMonth; i++) calendarDays.push(i);

            return (
                <div className="max-w-md mx-auto min-h-screen flex flex-col bg-white dark:bg-black relative overflow-hidden">
                    <header className="px-6 pt-10 pb-4 flex items-center justify-between sticky top-0 bg-white/80 dark:bg-black/80 backdrop-blur-md z-40">
                        <div className="flex items-center gap-2">
                            <img src="https://i.ibb.co/ZRjmkWdj/Cream-Orange-Elegant-Mosque-Islamic-Center-Logo.png" className="w-8 h-8 rounded-lg" />
                            <h1 className="font-extrabold text-lg text-emerald-600">SalahTracker</h1>
                        </div>
                        <div className="flex items-center gap-2">
                            {/* Streak Icon on Top */}
                            <div className="flex items-center gap-1 bg-orange-100 dark:bg-orange-900/30 px-3 py-1.5 rounded-full mr-1">
                                <Icon name="flame" size={14} className="text-orange-500 fill-orange-500" />
                                <span className="text-xs font-black text-orange-600 dark:text-orange-400">{streak}</span>
                            </div>
                            <button onClick={() => setDarkMode(!darkMode)} className="p-2 bg-slate-100 dark:bg-slate-900 rounded-full active:scale-90 transition-transform">
                                <Icon name={darkMode ? "sun" : "moon"} size={18} />
                            </button>
                            <button onClick={() => setView(view === 'daily' ? 'stats' : 'daily')} className="p-2 bg-slate-100 dark:bg-slate-900 rounded-full active:scale-90 transition-transform">
                                <Icon name={view === 'daily' ? "bar-chart-2" : "home"} size={18} />
                            </button>
                        </div>
                    </header>

                    <main className="flex-1 p-6 space-y-6 overflow-y-auto pb-24 no-scrollbar">
                        {view === 'daily' ? (
                            <div className="animate-fade-in space-y-6">
                                {/* Calendar Trigger Button (Blue) */}
                                <div className="flex items-center gap-2">
                                    <button onClick={() => setCurrentDate(new Date(currentDate.setDate(currentDate.getDate()-1)))} className="p-3 bg-slate-100 dark:bg-slate-900 rounded-xl"><Icon name="chevron-left" /></button>
                                    <button onClick={() => setIsCalendarOpen(true)} className="flex-1 py-3 flex items-center justify-center gap-2 font-black text-white bg-blue-600 rounded-xl shadow-lg active:scale-[0.98]">
                                        <Icon name="calendar" size={18} />
                                        {currentDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', weekday: 'short' })}
                                    </button>
                                    <button onClick={() => setCurrentDate(new Date(currentDate.setDate(currentDate.getDate()+1)))} disabled={dateKey === new Date().toLocaleDateString('en-CA')} className="p-3 bg-slate-100 dark:bg-slate-900 rounded-xl disabled:opacity-20"><Icon name="chevron-right" /></button>
                                </div>

                                {/* Prayers List */}
                                <div className="space-y-4">
                                    {prayers.map(p => {
                                        const status = records[dateKey]?.[p.id];
                                        return (
                                            <div key={p.id} className="bg-white dark:bg-slate-950 p-4 rounded-3xl border border-slate-100 dark:border-slate-800 shadow-sm">
                                                <h3 className="font-bold mb-3 flex items-center gap-2 uppercase text-[10px] tracking-widest text-slate-500"><Icon name={p.icon} size={16} className="text-emerald-500"/> {p.name}</h3>
                                                <div className="grid grid-cols-3 gap-2">
                                                    {[{id:'on_time',l:'Done',c:'bg-emerald-500'},{id:'late',l:'Late',c:'bg-amber-500'},{id:'missed',l:'Missed',c:'bg-rose-500'}].map(b => (
                                                        <button key={b.id} onClick={() => handleUpdate(p.id, b.id)} className={`py-3 rounded-xl text-[10px] font-black uppercase transition-all active:scale-95 ${status === b.id ? `${b.c} text-white shadow-md` : 'bg-slate-50 dark:bg-slate-900 text-slate-400'}`}>{b.l}</button>
                                                    ))}
                                                </div>
                                            </div>
                                        )
                                    })}
                                </div>

                                {/* AI Coach Card */}
                                <div className="bg-gradient-to-br from-indigo-600 to-purple-700 rounded-[2rem] p-6 text-white text-center shadow-lg">
                                    <p className="text-[10px] font-black uppercase opacity-60 mb-2 tracking-widest flex items-center justify-center gap-1"><Icon name="sparkles" size={12} /> AI Spiritual Coach</p>
                                    {reflection ? <p className="text-sm font-bold italic leading-relaxed animate-fade-in">"{reflection}"</p> : 
                                    <button onClick={fetchReflection} className="bg-white/20 px-6 py-3 rounded-xl text-xs font-bold w-full active:scale-95 transition-transform">{loadingRef ? "Seeking..." : "Get Daily Reflection"}</button>}
                                </div>
                            </div>
                        ) : (
                            <div className="animate-fade-in space-y-6">
                                <h2 className="text-2xl font-black px-2">Lifetime Summary</h2>
                                <div className="grid grid-cols-3 gap-3">
                                    <div className="bg-emerald-500/10 p-4 rounded-2xl text-center border border-emerald-500/5"><p className="text-emerald-500 text-xl font-black">{lifetimeStats.on_time}</p><p className="text-[8px] font-bold uppercase opacity-60">On Time</p></div>
                                    <div className="bg-amber-500/10 p-4 rounded-2xl text-center border border-amber-500/5"><p className="text-amber-500 text-xl font-black">{lifetimeStats.late}</p><p className="text-[8px] font-bold uppercase opacity-60">Delayed</p></div>
                                    <div className="bg-rose-500/10 p-4 rounded-2xl text-center border border-rose-500/5"><p className="text-rose-500 text-xl font-black">{lifetimeStats.missed}</p><p className="text-[8px] font-bold uppercase opacity-60">Missed</p></div>
                                </div>
                                <div className="bg-white dark:bg-slate-950 p-6 rounded-[2rem] border border-slate-100 dark:border-slate-800 flex items-center gap-4">
                                    <div className="w-12 h-12 bg-emerald-100 dark:bg-emerald-900/30 rounded-full flex items-center justify-center"><Icon name="award" className="text-emerald-600" /></div>
                                    <div>
                                        <p className="text-[10px] font-black uppercase text-slate-400">Current Rank</p>
                                        <p className="text-lg font-black">{streak > 15 ? 'Mumin' : streak > 5 ? 'Steady' : 'Beginner'}</p>
                                    </div>
                                </div>
                                <button onClick={() => setView('daily')} className="w-full py-5 bg-emerald-600 text-white rounded-[2rem] font-bold shadow-lg active:scale-[0.98]">Back to Home</button>
                            </div>
                        )}
                    </main>

                    {/* CALENDAR BOTTOM SHEET */}
                    {isCalendarOpen && (
                        <div className="fixed inset-0 z-[100] flex items-end justify-center bg-black/60 backdrop-blur-sm" onClick={() => setIsCalendarOpen(false)}>
                            <div className="w-full max-w-md bg-white dark:bg-slate-950 rounded-t-[2.5rem] p-6 pb-12 animate-slide-up shadow-2xl" onClick={e => e.stopPropagation()}>
                                <div className="w-10 h-1 bg-slate-200 dark:bg-slate-800 rounded-full mx-auto mb-6"></div>
                                <div className="flex justify-between items-center mb-6">
                                    <h3 className="font-black text-xl">{monthNames[month]} {year}</h3>
                                    <button onClick={() => {setCurrentDate(new Date()); setIsCalendarOpen(false);}} className="text-emerald-600 font-bold text-sm bg-emerald-50 dark:bg-emerald-900/30 px-3 py-1 rounded-full">Today</button>
                                </div>
                                <div className="grid grid-cols-7 gap-1 text-center">
                                    {['S','M','T','W','T','F','S'].map(d => <div key={d} className="text-[10px] font-black text-slate-400 py-2">{d}</div>)}
                                    {calendarDays.map((day, idx) => (
                                        <button 
                                            key={idx} disabled={!day}
                                            onClick={() => { const d = new Date(year, month, day); setCurrentDate(d); setIsCalendarOpen(false); }}
                                            className={`aspect-square flex items-center justify-center rounded-xl font-bold transition-all ${day === currentDate.getDate() ? 'bg-blue-600 text-white scale-110 shadow-md' : 'hover:bg-slate-100 dark:hover:bg-slate-800'} ${!day && 'opacity-0'}`}
                                        >{day}</button>
                                    ))}
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('./sw.js', { scope: './' })
            .then(reg => console.log('Success!', reg))
            .catch(err => console.log('Failure!', err));
        });
      }
    </script> 
  </body>
</html> 
