import React, { useState, useEffect, useMemo } from 'react';
import { 
  Sun, 
  Moon, 
  BarChart2, 
  Flame, 
  Calendar as CalendarIcon, 
  ChevronLeft, 
  ChevronRight, 
  Check, 
  Clock, 
  X, 
  Sparkles,
  Trophy,
  History,
  Sunrise,
  Sunset,
  CloudSun,
  MoonStar
} from 'lucide-react';

const App = () => {
  // --- State ---
  const [records, setRecords] = useState(() => JSON.parse(localStorage.getItem('salah_records') || '{}'));
  const [currentDate, setCurrentDate] = useState(new Date());
  const [view, setView] = useState('daily');
  const [reflection, setReflection] = useState(null);
  const [loadingRef, setLoadingRef] = useState(false);
  const [darkMode, setDarkMode] = useState(localStorage.getItem('theme') !== 'light');

  const prayers = [
    { id: 'fajr', name: 'Fajr', detail: 'Dawn / Pre-Sunrise', icon: Sunrise },
    { id: 'dhuhr', name: 'Dhuhr', detail: 'Post-Zenith', icon: Sun },
    { id: 'asr', name: 'Asr', detail: 'Mid-Afternoon Shadow', icon: CloudSun },
    { id: 'maghrib', name: 'Maghrib', detail: 'Just after Sunset', icon: Sunset },
    { id: 'isha', name: 'Isha', detail: 'Nightfall / Darkness', icon: MoonStar }
  ];

  const dateKey = currentDate.toLocaleDateString('en-CA');

  // --- Effects ---
  useEffect(() => {
    if (darkMode) {
      document.documentElement.classList.add('dark');
      localStorage.setItem('theme', 'dark');
    } else {
      document.documentElement.classList.remove('dark');
      localStorage.setItem('theme', 'light');
    }
  }, [darkMode]);

  useEffect(() => {
    localStorage.setItem('salah_records', JSON.stringify(records));
  }, [records]);

  // --- Logic ---
  const handleUpdate = (id, status) => {
    setRecords(prev => ({
      ...prev,
      [dateKey]: {
        ...prev[dateKey],
        [id]: prev[dateKey]?.[id] === status ? null : status
      }
    }));
    setReflection(null); 
  };

  const streak = useMemo(() => {
    let count = 0;
    let d = new Date();
    const checkDate = (date) => {
      const k = date.toLocaleDateString('en-CA');
      return records[k] && Object.values(records[k]).some(v => v === 'on_time' || v === 'late');
    };

    if (!checkDate(d)) d.setDate(d.getDate() - 1);
    
    while (checkDate(d)) {
      count++;
      d.setDate(d.getDate() - 1);
      if (count > 365) break;
    }
    return count;
  }, [records]);

  const lifetimeStats = useMemo(() => {
    const stats = { on_time: 0, late: 0, missed: 0 };
    Object.values(records).forEach(day => {
      Object.values(day).forEach(status => {
        if (status && stats.hasOwnProperty(status)) {
          stats[status]++;
        }
      });
    });
    return stats;
  }, [records]);

  const progress = useMemo(() => {
    const dayData = records[dateKey] || {};
    const completed = Object.values(dayData).filter(v => v === 'on_time' || v === 'late').length;
    return (completed / 5) * 100;
  }, [records, dateKey]);

  const fetchReflection = async () => {
    setLoadingRef(true);
    const dayData = records[dateKey] || {};
    const summary = prayers.map(p => `${p.name}: ${dayData[p.id] || 'Not logged'}`).join(', ');
    
    try {
      const apiKey = ""; 
      const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{
            parts: [{ text: `The user has logged these prayers for today: ${summary}. Provide a very short, warm, and encouraging Islamic reflection (max 2 sentences) with emojis to motivate them.` }]
          }]
        })
      });
      const data = await res.json();
      setReflection(data.candidates?.[0]?.content?.parts?.[0]?.text || "May Allah keep you firm on your prayers. ðŸ¤²");
    } catch (e) {
      setReflection("Your efforts are seen by the Almighty. Keep going! ðŸ¤²");
    } finally {
      setLoadingRef(false);
    }
  };

  return (
    <div className="min-h-screen pb-10 bg-slate-50 dark:bg-black text-slate-900 dark:text-slate-100 transition-colors duration-300">
      {/* Header */}
      <header className="sticky top-0 z-50 bg-white/80 dark:bg-slate-950/90 backdrop-blur-md border-b border-slate-200 dark:border-slate-800 px-4 py-4 flex items-center justify-between">
        <div className="flex items-center gap-3">
          <div className="w-10 h-10 rounded-xl bg-white border border-slate-200 dark:border-slate-800 p-1 flex items-center justify-center overflow-hidden shadow-sm">
            <img 
              src="https://i.ibb.co/ZRjmkWdj/Cream-Orange-Elegant-Mosque-Islamic-Center-Logo.png" 
              alt="Logo" 
              className="w-full h-full object-contain"
              onError={(e) => { e.target.src = 'https://cdn-icons-png.flaticon.com/512/3241/3241485.png' }}
            />
          </div>
          <h1 className="font-bold text-lg text-emerald-600 dark:text-emerald-500">SalahTracker</h1>
        </div>
        
        <div className="flex items-center gap-2">
          <button 
            onClick={() => setDarkMode(!darkMode)}
            className="p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-full transition-colors"
          >
            {darkMode ? <Sun size={20} className="text-amber-400" /> : <Moon size={20} className="text-slate-500" />}
          </button>
          
          <button 
            onClick={() => setView(view === 'daily' ? 'stats' : 'daily')}
            className={`p-2 rounded-full transition-colors ${view === 'stats' ? 'bg-emerald-100 dark:bg-emerald-900/30 text-emerald-600' : 'hover:bg-slate-100 dark:hover:bg-slate-800'}`}
          >
            <BarChart2 size={20} />
          </button>
          
          <div className="flex items-center gap-1 bg-orange-100 dark:bg-orange-900/30 text-orange-600 dark:text-orange-400 px-3 py-1 rounded-full text-xs font-bold border border-orange-200 dark:border-orange-800/50">
            <Flame size={14} fill="currentColor" />
            {streak}
          </div>
        </div>
      </header>

      {/* Progress Bar */}
      <div className="h-1 bg-slate-200 dark:bg-slate-900">
        <div 
          className="h-full bg-emerald-500 transition-all duration-500 shadow-[0_0_8px_rgba(16,185,129,0.5)]" 
          style={{ width: `${progress}%` }}
        />
      </div>

      <main className="max-w-md mx-auto p-4 space-y-6">
        {view === 'daily' ? (
          <div className="animate-fade-in space-y-4">
            <div className="flex items-center justify-between bg-white dark:bg-slate-900 p-2 rounded-2xl border border-slate-200 dark:border-slate-800 shadow-sm">
              <button 
                onClick={() => setCurrentDate(new Date(currentDate.setDate(currentDate.getDate() - 1)))}
                className="p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-lg"
              >
                <ChevronLeft size={20} />
              </button>
              <div className="flex items-center gap-2 font-bold text-sm">
                <CalendarIcon size={16} className="text-emerald-500" />
                {currentDate.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' })}
              </div>
              <button 
                onClick={() => setCurrentDate(new Date(currentDate.setDate(currentDate.getDate() + 1)))}
                disabled={dateKey === new Date().toLocaleDateString('en-CA')}
                className="p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-lg disabled:opacity-20"
              >
                <ChevronRight size={20} />
              </button>
            </div>

            <div className="space-y-3">
              {prayers.map(p => {
                const status = records[dateKey]?.[p.id];
                const PrayerIcon = p.icon;
                return (
                  <div key={p.id} className="bg-white dark:bg-slate-900 rounded-2xl border border-slate-200 dark:border-slate-800 p-4 shadow-sm transition-all group">
                    <div className="flex justify-between items-center mb-4">
                      <div className="flex flex-col">
                        <span className="font-bold flex items-center gap-2 text-lg">
                          <PrayerIcon size={18} className="text-emerald-500" />
                          {p.name}
                        </span>
                        <span className="text-[10px] text-slate-400 font-medium ml-6 uppercase tracking-wider">
                          {p.detail}
                        </span>
                      </div>
                    </div>
                    <div className="grid grid-cols-3 gap-2">
                      {[
                        { id: 'on_time', label: 'On Time', icon: Check, color: 'emerald' },
                        { id: 'late', label: 'Late', icon: Clock, color: 'amber' },
                        { id: 'missed', label: 'Missed', icon: X, color: 'rose' }
                      ].map(btn => (
                        <button
                          key={btn.id}
                          onClick={() => handleUpdate(p.id, btn.id)}
                          className={`flex flex-col items-center gap-1 py-2 rounded-xl text-[10px] font-bold transition-all border
                            ${status === btn.id 
                              ? `bg-${btn.color}-500 border-${btn.color}-600 text-white shadow-md scale-105` 
                              : `bg-slate-50 dark:bg-slate-800 border-slate-100 dark:border-slate-700 text-slate-500 dark:text-slate-400`
                            }`}
                        >
                          <btn.icon size={14} />
                          {btn.label.toUpperCase()}
                        </button>
                      ))}
                    </div>
                  </div>
                );
              })}
            </div>

            <div className="mt-8 p-6 rounded-3xl bg-gradient-to-br from-indigo-500 to-purple-600 text-white shadow-xl shadow-indigo-500/20 relative overflow-hidden group">
              <div className="absolute -right-4 -top-4 opacity-10 group-hover:scale-110 transition-transform">
                <Sparkles size={120} />
              </div>
              <div className="relative z-10">
                <div className="flex items-center gap-2 mb-3 text-xs font-black uppercase tracking-widest opacity-90">
                  <Sparkles size={14} /> AI Spiritual Coach
                </div>
                {reflection ? (
                  <p className="text-sm font-medium leading-relaxed italic animate-fade-in">
                    "{reflection}"
                  </p>
                ) : (
                  <div className="space-y-3">
                    <p className="text-xs opacity-80">Log your prayers and get a personalized reflection to boost your spirit.</p>
                    <button 
                      onClick={fetchReflection}
                      disabled={loadingRef}
                      className="w-full py-3 bg-white text-indigo-600 rounded-xl font-bold text-sm hover:bg-indigo-50 transition-colors flex items-center justify-center gap-2 disabled:opacity-50"
                    >
                      {loadingRef ? "Consulting wisdom..." : "Get Today's Reflection"}
                    </button>
                  </div>
                )}
              </div>
            </div>
          </div>
        ) : (
          /* Stats View */
          <div className="animate-fade-in space-y-6">
            <h2 className="text-xl font-bold flex items-center gap-2">
              <BarChart2 className="text-emerald-500" /> Lifetime Analytics
            </h2>
            
            <div className="grid grid-cols-2 gap-4">
              <div className="bg-white dark:bg-slate-900 p-5 rounded-3xl border border-slate-200 dark:border-slate-800 text-center shadow-sm">
                <p className="text-[10px] text-slate-400 font-bold uppercase mb-1">Current Streak</p>
                <div className="flex justify-center items-center gap-1">
                  <Flame size={18} className="text-orange-500" fill="currentColor" />
                  <p className="text-3xl font-black text-orange-500">{streak}</p>
                </div>
                <p className="text-[10px] text-slate-500">Days Active</p>
              </div>
              <div className="bg-white dark:bg-slate-900 p-5 rounded-3xl border border-slate-200 dark:border-slate-800 text-center shadow-sm">
                <p className="text-[10px] text-slate-400 font-bold uppercase mb-1">Spiritual Rank</p>
                <div className="flex justify-center items-center gap-1">
                  <Trophy size={18} className="text-emerald-500" />
                  <p className="text-xl font-bold text-emerald-500">{streak > 15 ? 'Mumin' : 'Abed'}</p>
                </div>
                <p className="text-[10px] text-slate-500">Consistency Level</p>
              </div>
            </div>

            <div className="bg-white dark:bg-slate-900 p-6 rounded-3xl border border-slate-200 dark:border-slate-800 shadow-sm space-y-4">
              <h3 className="text-xs font-black uppercase tracking-wider text-slate-400 flex items-center gap-2">
                <History size={14} /> Lifetime Tally
              </h3>
              <div className="grid grid-cols-3 gap-3">
                <div className="flex flex-col items-center p-3 bg-emerald-50 dark:bg-emerald-950/20 rounded-2xl border border-emerald-100 dark:border-emerald-900/50">
                  <span className="text-2xl font-black text-emerald-600">{lifetimeStats.on_time}</span>
                  <span className="text-[9px] font-bold text-emerald-600/70 uppercase">On Time</span>
                </div>
                <div className="flex flex-col items-center p-3 bg-amber-50 dark:bg-amber-950/20 rounded-2xl border border-amber-100 dark:border-amber-900/50">
                  <span className="text-2xl font-black text-amber-600">{lifetimeStats.late}</span>
                  <span className="text-[9px] font-bold text-amber-600/70 uppercase">Delayed</span>
                </div>
                <div className="flex flex-col items-center p-3 bg-rose-50 dark:bg-rose-950/20 rounded-2xl border border-rose-100 dark:border-rose-900/50">
                  <span className="text-2xl font-black text-rose-600">{lifetimeStats.missed}</span>
                  <span className="text-[9px] font-bold text-rose-600/70 uppercase">Missed</span>
                </div>
              </div>
            </div>

            <div className="p-8 bg-emerald-500 rounded-3xl text-white text-center shadow-lg shadow-emerald-500/20">
              <p className="text-sm italic font-medium opacity-95">"The first thing for which a person will be brought to account on the Day of Resurrection will be their prayer."</p>
            </div>

            <button 
              onClick={() => setView('daily')}
              className="w-full py-4 bg-slate-900 dark:bg-white text-white dark:text-slate-900 rounded-2xl font-bold transition-transform active:scale-95 shadow-xl"
            >
              Back to Tracker
            </button>
          </div>
        )}
      </main>

      <style dangerouslySetInnerHTML={{ __html: `
        @keyframes fadeIn {
          from { opacity: 0; transform: translateY(10px); }
          to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
          animation: fadeIn 0.4s ease-out forwards;
        }
      `}} />
    </div>
  );
};

export default App;
